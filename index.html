<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NC por Patios</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="icon" href="https://i.postimg.cc/4dRSvzKv/image.png" type="image/png">
  <style>
    body {
      touch-action: pan-y; /* Previene el zoom en móviles al arrastrar horizontalmente */
    }
    .map-container {
      position: relative;
      /* Se elimina overflow: hidden para evitar que los tooltips se recorten */
      margin-bottom: 20px;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      background-color: #f8f9fa;
      /* Añadir una transición suave para el cursor */
      transition: cursor 0.2s ease-in-out;
    }
    .map-container.reposicionando {
      cursor: crosshair; /* Cursor diferente cuando se espera un clic para posicionar */
    }

    .map-img {
      width: 100%;
      height: auto;
      display: block;
    }

    .pin-con-tooltip {
      position: absolute;
      z-index: 10;
      transform: translate(-50%, -50%);
    }

    .pin {
      width: 24px;
      height: 24px;
      background-color: #dc3545;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 6px rgba(0,0,0,0.5);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .pin:hover {
      transform: scale(1.2);
      background-color: #ff0000;
    }

    .pin.modo-edicion {
      background-color: #0d6efd !important;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    .tooltip {
      position: absolute;
      top: 100%; /* Siempre abajo del pin */
      left: 50%;
      transform: translateX(-50%); /* Centra el tooltip horizontalmente */
      background-color: white;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px;
      padding: 12px;
      width: 220px; /* Ancho fijo del tooltip */
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      margin-top: 15px; /* Margen para separar del pin */
      z-index: 100;
    }

    .tooltip:before {
      content: '';
      position: absolute;
      top: -8px; /* Flecha apuntando hacia arriba, desde la parte superior del tooltip */
      left: 50%;
      transform: translateX(-50%); /* Centra la flecha */
      border-width: 8px;
      border-style: solid;
      border-color: transparent transparent white transparent; /* Flecha apuntando hacia abajo */
    }

    /* ESTILO PARA MOSTRAR EL TOOLTIP AL HACER HOVER SOBRE EL CONTENEDOR DEL PIN */
    .pin-con-tooltip:hover .tooltip {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0); /* Desactivar traslación vertical al hover si ya está abajo */
    }
    
    /* Nueva lógica para posicionar el tooltip cuando está cerca de los bordes */
    .pin-con-tooltip.tooltip-left-aligned .tooltip {
        transform: translateX(calc(-50% + var(--offset-left, 0px)));
    }

    .pin-con-tooltip.tooltip-left-aligned .tooltip:before {
        transform: translateX(calc(-50% - var(--offset-left, 0px) + 12px));
    }

    .pin-con-tooltip.tooltip-right-aligned .tooltip {
        transform: translateX(calc(-50% - var(--offset-right, 0px)));
    }

    .pin-con-tooltip.tooltip-right-aligned .tooltip:before {
        transform: translateX(calc(-50% + var(--offset-right, 0px) - 12px));
    }
    
    /* Ajuste para el hover con alineación horizontal */
    .pin-con-tooltip.tooltip-left-aligned:hover .tooltip {
        transform: translateX(calc(-50% + var(--offset-left, 0px))) translateY(0);
    }
    .pin-con-tooltip.tooltip-right-aligned:hover .tooltip {
        transform: translateX(calc(-50% - var(--offset-right, 0px))) translateY(0);
    }


    .pins-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .pins-list li {
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .pins-list li:hover {
      background-color: #f8f9fa;
    }

    @media (max-width: 768px) {
      .map-container {
        margin-top: 20px;
      }

      .pins-list {
        max-height: 300px;
      }

      .tooltip {
        width: 180px; /* Reducir el ancho en móviles si es necesario */
      }
    }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="bi bi-pin-map-fill me-2"></i>NC por Patios
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <div class="nav-link">
              <div id="selectorMapaDiv" class="d-flex align-items-center">
                <label for="selectorMapa" class="form-label me-2 mb-0 text-white">Mapa:</label>
                <select id="selectorMapa" class="form-select form-select-sm">
                  <option value="cordillera">Cordillera</option>
                  <option value="deco y tambores">Deco y Tambores</option>
                  <option value="sur">Sur</option>
                  <option value="ofi y bodega 4">Oficina y Bodega 4</option>
                  <option value="pallets y central">Pallets y Central</option>
                  <option value="punto verde y materiales">Punto Verde</option>
                  <option value="nuevo sur">Nuevo Sur</option>
                </select>
              </div>
            </div>
          </li>
          <li class="nav-item">
            <div class="nav-link">
              <div id="filtroEncargadoDiv" class="d-flex align-items-center">
                <label for="filtroEncargado" class="form-label me-2 mb-0 text-white">Encargado:</label>
                <select id="filtroEncargado" class="form-select form-select-sm">
                  <option value="todos">Todos</option>
                </select>
              </div>
            </div>
          </li>
          <li class="nav-item d-none" id="userManagementLinkContainer">
             </li>
        </ul>
        <div class="d-flex align-items-center">
            <span id="userGreeting" class="navbar-text me-3 text-white"></span> <button id="downloadCsvBtn" class="btn btn-outline-light btn-sm me-2 d-none">
                <i class="bi bi-download me-1"></i>Descargar todo
            </button>
            <button id="uploadCsvBtn" class="btn btn-outline-light btn-sm me-2 d-none">
                <i class="bi bi-upload me-1"></i>Subir CSV
            </button>
            <input type="file" id="csvFileInput" accept=".csv" class="d-none">
            <button id="analysisBtn" class="btn btn-outline-light btn-sm me-2">
                <i class="bi bi-bar-chart-fill me-1"></i>Análisis
            </button>
            <button id="mainLogoutBtn" class="btn btn-outline-light btn-sm d-none"> <i class="bi bi-box-arrow-right me-1"></i>Cerrar sesión
            </button>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-8">
        <div class="card mb-4">
          <div class="card-header bg-white">
            <h5 class="card-title mb-0">Mapa seleccionado</h5>
          </div>
          <div class="card-body p-0">
            <div class="map-container" id="contenedor">
              <img src="cordillera.JPG" alt="Imagen base" id="imagen" class="map-img">
            </div>
          </div>
          <div class="card-footer bg-white small text-muted">
            Haz clic en el mapa para agregar un nuevo pin (solo administradores)
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card">
          <div class="card-header bg-white">
            <h5 class="card-title mb-0">Pines del mapa</h5>
          </div>
          <div class="card-body p-0">
            <ul id="listaPinesUl" class="list-group list-group-flush pins-list"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="formularioModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="formTitulo">Agregar Pin</h5>
          <button type="button" class="btn-close" onclick="cerrarFormulario()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="instruccionesArrastre" class="alert alert-info d-none mb-3">
            <i class="bi bi-arrows-move me-2"></i>Haz clic en el mapa para posicionar el pin.
          </div>
          <form id="pinForm">
            <div class="mb-3">
              <label for="titulo" class="form-label">Título</label>
              <input type="text" class="form-control" id="titulo" placeholder="Título" required>
            </div>
            <div class="mb-3">
              <label for="descripcion" class="form-label">Descripción</label>
              <textarea class="form-control" id="descripcion" rows="3" placeholder="Descripción"></textarea>
            </div>
            <div class="mb-3">
              <label for="tipoNC" class="form-label">Tipo de NC</label>
              <select class="form-select" id="tipoNC" required>
                <option value="">Seleccione un tipo</option>
                <option value="Limpieza y orden">Limpieza y orden</option>
                <option value="Infraestructura">Infraestructura</option>
                <option value="BPM">BPM</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="estatus" class="form-label">Estatus</label>
              <select class="form-select" id="estatus" required>
                <option value="">Seleccione un estatus</option>
                <option value="Nueva">Nueva</option>
                <option value="Gestion en proceso">Gestión en proceso</option>
                <option value="Solicitud de Cierre">Solicitud de Cierre</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="fechaCreacion" class="form-label">Fecha de Creación</label>
              <input type="date" class="form-control" id="fechaCreacion" required>
            </div>
            <div class="mb-3">
              <label for="encargado" class="form-label">Encargado</label>
              <select class="form-select" id="encargado" required>
                <option value="">Seleccione un encargado</option>
                <option value="Jonathan Pinto">Jonathan Pinto</option>
                <option value="Carla Moreno">Carla Moreno</option>
                <option value="Carmelo Chamorro">Carmelo Chamorro</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="imagenURL" class="form-label">URL de imagen (opcional)</label>
              <input type="text" class="form-control" id="imagenURL" placeholder="URL de imagen">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="cerrarFormulario()">Cancelar</button>
          <button type="button" class="btn btn-info text-white" id="btnReposicionar" style="display:none;">
            <i class="bi bi-geo-alt-fill me-1"></i> Reposicionar Pin
          </button>
          <button type="button" class="btn btn-primary" onclick="guardarPin()" id="btnGuardar">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
// IMPORTACIONES FIREBASE (ajustadas)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

// --- START: NEW AUTHENTICATION LOGIC ---
const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
if (!loggedInUser) {
    window.location.href = 'login.html'; // Redirect if not logged in
}

const currentUser = loggedInUser; // Store user info globally if needed
const isAdmin = currentUser && (currentUser.role === 'admin' || currentUser.role === 'superadmin');
const isSuperAdmin = currentUser && currentUser.role === 'superadmin';

console.log("Usuario logueado:", currentUser.username, "Rol:", currentUser.role, "Es Admin?", isAdmin, "Es SuperAdmin?", isSuperAdmin);
// --- END: NEW AUTHENTICATION LOGIC ---

let unsubscribePines = null;
let reposicionandoPin = false;
let pinEnEdicion = null;
let clickPos = { x: 0, y: 0 };
let editandoPinId = null;

const firebaseConfig = {
  apiKey: "AIzaSyB9LTFIpJL25PmlEAgkm37278DzgQJvMGI",
  authDomain: "pinesnc-a31d6.firebaseapp.com",
  projectId: "pinesnc-a31d6",
  storageBucket: "pinesnc-a31d6.appspot.com",
  messagingSenderId: "198447961429",
  appId: "1:198447961429:web:eaae1f6765c0dbeff28bdc"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const pinesRef = collection(db, "pines");

// Elementos del DOM
const contenedor = document.getElementById('contenedor');
const downloadCsvBtn = document.getElementById('downloadCsvBtn');
const uploadCsvBtn = document.getElementById('uploadCsvBtn');
const csvFileInput = document.getElementById('csvFileInput');
const analysisBtn = document.getElementById('analysisBtn');

const tituloInput = document.getElementById('titulo');
const descripcionInput = document.getElementById('descripcion');
const imagenURLInput = document.getElementById('imagenURL');
const encargadoInput = document.getElementById('encargado');
const tipoNCInput = document.getElementById('tipoNC');
const estatusInput = document.getElementById('estatus');
const fechaCreacionInput = document.getElementById('fechaCreacion');
const formTitulo = document.getElementById('formTitulo');
const imagen = document.getElementById('imagen');
const selectorMapa = document.getElementById('selectorMapa');
const filtroEncargado = document.getElementById('filtroEncargado');
const listaPinesUl = document.getElementById('listaPinesUl');
const formularioModal = new bootstrap.Modal(document.getElementById('formularioModal'));
const instruccionesArrastre = document.getElementById('instruccionesArrastre');
const btnReposicionar = document.getElementById('btnReposicionar');
const btnGuardar = document.getElementById('btnGuardar');

const formFields = [tituloInput, descripcionInput, imagenURLInput, encargadoInput, tipoNCInput, estatusInput, fechaCreacionInput];

const imagenes = {
  "cordillera": "https://i.postimg.cc/rsSmkKSM/cordillera.jpg",
  "deco y tambores": "https://i.postimg.cc/5tYfJXVT/deco-y-tambores.jpg",
  "sur": "https://i.postimg.cc/MGJG613z/sur.jpg",
  "ofi y bodega 4": "https://i.postimg.cc/9MVMK0nG/image.png",
  "pallets y central": "https://i.postimg.cc/L4xhtY5V/pallets-y-central.jpg",
  "punto verde y materiales": "https://i.postimg.cc/25srSCj6/punto-verde-y-materiales.jpg",
  "nuevo sur": "https://i.postimg.cc/SRq4cVMb/nuevo-sur.jpg"
};

// --- START: UPDATE UI BASED ON NEW AUTH ---
function updateNavbarAndAdminFeatures() {
    const navbarUserManagementLi = document.getElementById('userManagementLinkContainer');
    const mainLogoutBtn = document.getElementById('mainLogoutBtn');
    const greetingElement = document.getElementById('userGreeting');

    if (greetingElement) {
        greetingElement.textContent = `Hola, ${currentUser.username} (${currentUser.role})`;
    }

    if (mainLogoutBtn) {
        mainLogoutBtn.classList.remove('d-none');
        mainLogoutBtn.onclick = () => {
            sessionStorage.removeItem('loggedInUser');
            window.location.href = 'login.html';
        };
    }

    // Ocultar botones de login/logout de Google si existieran y no se eliminaron del HTML
    const oldLoginBtnHTML = document.getElementById('loginBtn'); // ID original del botón de Google
    if (oldLoginBtnHTML) oldLoginBtnHTML.classList.add('d-none');
    const oldLogoutBtnHTML = document.getElementById('logoutBtn'); // ID original del botón de Google
     if (oldLogoutBtnHTML) oldLogoutBtnHTML.classList.add('d-none');


    if (isSuperAdmin && navbarUserManagementLi) {
        navbarUserManagementLi.innerHTML = `<a class="nav-link text-white" href="user_management.html"><i class="bi bi-people-fill me-1"></i>Gestionar Usuarios</a>`;
        navbarUserManagementLi.classList.remove('d-none');
    } else if (navbarUserManagementLi) {
        navbarUserManagementLi.classList.add('d-none');
    }

    if (isAdmin) {
      downloadCsvBtn.classList.remove('d-none');
      uploadCsvBtn.classList.remove('d-none');
      document.querySelector('.card-footer.bg-white.small.text-muted').textContent = 'Haz clic en el mapa para agregar un nuevo pin.';
    } else {
      downloadCsvBtn.classList.add('d-none');
      uploadCsvBtn.classList.add('d-none');
      document.querySelector('.card-footer.bg-white.small.text-muted').textContent = 'Visualización de pines. Inicia sesión como administrador para editar.';
    }
}
// --- END: UPDATE UI BASED ON NEW AUTH ---

function escapeHtml(str) {
  if (!str) return '';
  const parser = new DOMParser();
  const doc = parser.parseFromString(str, 'text/html');
  return doc.body.textContent || "";
}

function escapeCsv(str) {
    if (str === null || str === undefined) return '';
    str = String(str);
    if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
        return `"${str.replace(/"/g, '""')}"`;
    }
    return str;
}

function cargarImagen(imagenId) {
  imagen.src = imagenes[imagenId];
  imagen.onload = () => {
    cargarPines(imagenId);
  };
  if (imagen.complete && imagen.naturalHeight !== 0) {
      cargarPines(imagenId);
  }
}

selectorMapa.addEventListener('change', () => cargarImagen(selectorMapa.value));

function mostrarFormulario(esEdicion = false) {
  if (!isAdmin) {
      alert("Permiso denegado.");
      return;
  }
  if (esEdicion) {
    btnReposicionar.style.display = 'inline-block';
    instruccionesArrastre.classList.add('d-none');
  } else {
    btnReposicionar.style.display = 'none';
    instruccionesArrastre.classList.remove('d-none');
    toggleFormFields(false);
  }
  formularioModal.show();
}

function toggleFormFields(enable) {
    formFields.forEach(field => field.disabled = !enable);
    if (enable) {
        instruccionesArrastre.classList.add('d-none');
    } else {
        instruccionesArrastre.classList.remove('d-none');
        instruccionesArrastre.innerHTML = '<i class="bi bi-arrows-move me-2"></i>Haz clic en el mapa para posicionar el pin.';
    }
    btnGuardar.disabled = !enable;
}

function parseCsv(csvString) {
    const lines = csvString.split('\n').filter(line => line.trim() !== '');
    if (lines.length === 0) return [];
    const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
    const data = [];
    for (let i = 1; i < lines.length; i++) {
        const currentLine = lines[i];
        if (!currentLine) continue;
        const values = [];
        let inQuote = false;
        let currentField = "";
        for (let j = 0; j < currentLine.length; j++) {
            const char = currentLine[j];
            if (char === '"') {
                inQuote = !inQuote;
                if (inQuote && currentLine[j+1] === '"') {
                    currentField += '"';
                    j++;
                }
            } else if (char === ',' && !inQuote) {
                values.push(currentField.trim());
                currentField = "";
            } else {
                currentField += char;
            }
        }
        values.push(currentField.trim());
        const cleanValues = values.map(val => val.replace(/^"|"$/g, '').replace(/""/g, '"'));
        const rowData = {};
        headers.forEach((header, index) => {
            let firebaseKey = header;
            if (header === "ID") firebaseKey = "id";
            else if (header === "Titulo") firebaseKey = "titulo";
            else if (header === "Descripcion") firebaseKey = "descripcion";
            else if (header === "Tipo de NC") firebaseKey = "tipoNC";
            else if (header === "Estatus") firebaseKey = "estatus";
            else if (header === "Fecha de Creacion") firebaseKey = "fechaCreacion";
            else if (header === "Encargado") firebaseKey = "encargado";
            else if (header === "URL Imagen") firebaseKey = "imagenURL";
            else if (header === "Mapa (ID Imagen)") firebaseKey = "imagenId";
            else if (header === "Coordenada X (%)") firebaseKey = "x";
            else if (header === "Coordenada Y (%)") firebaseKey = "y";
            rowData[firebaseKey] = cleanValues[index];
        });
        data.push(rowData);
    }
    return data;
}

async function handleUploadCsv() {
    if (!isAdmin) {
        alert("Permiso denegado. Solo los administradores pueden subir archivos CSV.");
        return;
    }
    const confirmUpload = confirm(
        "ADVERTENCIA: ¿Está seguro que desea subir este archivo CSV? " +
        "Esta acción ELIMINARÁ TODOS LOS PINES EXISTENTES en la base de datos " +
        "y los reemplazará con los datos del CSV.\n\n" +
        "Por favor, asegúrese de que su archivo CSV tenga la siguiente estructura de encabezados (el orden no importa, pero los nombres sí deben coincidir):\n\n" +
        "ID, Titulo, Descripcion, Tipo de NC, Estatus, Fecha de Creacion, Encargado, URL Imagen, Mapa (ID Imagen), Coordenada X (%), Coordenada Y (%)\n\n" +
        "Ejemplo de fila de datos:\n" +
        "\"123\", \"Problema de limpieza\", \"Se encontró basura cerca del sector\", \"Limpieza y orden\", \"Nueva\", \"2024-05-20\", \"Jonathan Pinto\", \"\", \"cordillera\", 50.12, 30.45\n\n" +
        "Asegúrese que 'Coordenada X (%)' y 'Coordenada Y (%)' sean valores numéricos."
    );

    if (!confirmUpload) {
        return;
    }
    csvFileInput.click();
}

csvFileInput.addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if (!file) {
        return;
    }
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const csvContent = e.target.result;
            const pinsData = parseCsv(csvContent);

            if (pinsData.length === 0) {
                alert("El archivo CSV está vacío o no contiene datos válidos.");
                return;
            }

            const existingPinesSnapshot = await getDocs(pinesRef);
            const deletePromises = [];
            existingPinesSnapshot.forEach((docSnap) => {
                deletePromises.push(deleteDoc(doc(db, "pines", docSnap.id)));
            });
            await Promise.all(deletePromises);
            console.log("Todos los pines existentes eliminados.");

            const addPromises = [];
            for (const pin of pinsData) {
                pin.x = parseFloat(pin.x);
                pin.y = parseFloat(pin.y);
                const { id, ...pinDataWithoutId } = pin;
                const cleanPinData = Object.fromEntries(
                    Object.entries(pinDataWithoutId).filter(([_, v]) => v !== undefined && v !== null && v !== '')
                );
                addPromises.push(addDoc(pinesRef, cleanPinData));
            }
            await Promise.all(addPromises);
            alert(`Se han subido ${pinsData.length} pines exitosamente.`);
            console.log(`${pinsData.length} pines subidos exitosamente.`);

        } catch (error) {
            console.error("Error al procesar el archivo CSV:", error);
            alert("Error al procesar el archivo CSV. Asegúrate de que el formato sea correcto y que las columnas coincidan.");
        } finally {
            csvFileInput.value = '';
        }
    };
    reader.readAsText(file);
});

function cerrarFormulario() {
  formularioModal.hide();
  tituloInput.value = '';
  descripcionInput.value = '';
  imagenURLInput.value = '';
  encargadoInput.value = '';
  tipoNCInput.value = '';
  estatusInput.value = '';
  fechaCreacionInput.value = '';
  formTitulo.textContent = 'Agregar Pin';

  if (pinEnEdicion) {
    pinEnEdicion.style.zIndex = '10';
    pinEnEdicion.querySelector('.pin').classList.remove('modo-edicion');
  }

  reposicionandoPin = false;
  pinEnEdicion = null;
  editandoPinId = null;
  toggleFormFields(true);
  btnReposicionar.style.display = 'none';
  contenedor.classList.remove('reposicionando');
}

async function guardarPin() {
  if (!isAdmin) {
      alert("Permiso denegado.");
      return;
  }
  const titulo = tituloInput.value;
  const descripcion = descripcionInput.value;
  const imagenURL = imagenURLInput.value;
  const encargado = encargadoInput.value;
  const tipoNC = tipoNCInput.value;
  const estatus = estatusInput.value;
  const fechaCreacion = fechaCreacionInput.value;
  const imagenId = selectorMapa.value;

  if (!titulo || !encargado || !tipoNC || !estatus || !fechaCreacion) {
    alert("Por favor complete los campos requeridos (Título, Encargado, Tipo de NC, Estatus, Fecha de Creación)");
    return;
  }

  try {
    const rect = imagen.getBoundingClientRect();
    const finalX_percent = (clickPos.x / rect.width) * 100;
    const finalY_percent = (clickPos.y / rect.height) * 100;

    if (isNaN(finalX_percent) || isNaN(finalY_percent)) {
        console.error("ERROR: Coordenadas finales son NaN. No se puede guardar el pin.");
        alert("Error: No se pudo determinar la posición del pin.");
        return;
    }

    if (editandoPinId) {
      await updateDoc(doc(db, "pines", editandoPinId), {
        x: finalX_percent,
        y: finalY_percent,
        titulo,
        descripcion,
        imagenURL,
        encargado,
        tipoNC,
        estatus,
        fechaCreacion
      });
    } else {
      await addDoc(pinesRef, {
        x: finalX_percent,
        y: finalY_percent,
        titulo,
        descripcion,
        imagenURL,
        encargado,
        tipoNC,
        estatus,
        fechaCreacion,
        imagenId
      });
    }
    cerrarFormulario();
  } catch (e) {
    alert("Error al guardar el pin: " + e.message);
    console.error("Error al guardar el pin:", e);
  }
}

function agregarPinVisual(pinData, id) {
  const div = document.createElement('div');
  div.className = 'pin-con-tooltip';
  div.style.left = `${pinData.x}%`;
  div.style.top = `${pinData.y}%`;
  div.dataset.encargado = pinData.encargado || '';
  div.dataset.pinId = id;

  const mapRect = contenedor.getBoundingClientRect();
  const pinAbsX = (pinData.x / 100) * mapRect.width;
  const tooltipEstimatedWidth = 220;
  const padding = 10;

  let horizontalOffset = 0;
  const potentialTooltipLeft = pinAbsX - (tooltipEstimatedWidth / 2);
  const potentialTooltipRight = pinAbsX + (tooltipEstimatedWidth / 2);

  if (potentialTooltipLeft < padding) {
    horizontalOffset = padding - potentialTooltipLeft;
    div.classList.add('tooltip-left-aligned');
    div.style.setProperty('--offset-left', `${horizontalOffset}px`);
    div.classList.remove('tooltip-right-aligned');
  } else if (potentialTooltipRight > (mapRect.width - padding)) {
    horizontalOffset = potentialTooltipRight - (mapRect.width - padding);
    div.classList.add('tooltip-right-aligned');
    div.style.setProperty('--offset-right', `${horizontalOffset}px`);
    div.classList.remove('tooltip-left-aligned');
  } else {
    div.classList.remove('tooltip-left-aligned', 'tooltip-right-aligned');
    div.style.removeProperty('--offset-left');
    div.style.removeProperty('--offset-right');
  }

  let fechaCreacionFormateada = 'N/A';
  if (pinData.fechaCreacion) {
    const parts = pinData.fechaCreacion.split('-');
    const localDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    fechaCreacionFormateada = localDate.toLocaleDateString('es-CL');
  }

  div.innerHTML = `
    <div class="pin"></div>
    <div class="tooltip">
      <h6 class="mb-2 fw-bold">${escapeHtml(pinData.titulo)}</h6>
      <p class="small mb-2">${escapeHtml(pinData.descripcion || 'Sin descripción')}</p>
      <p class="small text-muted mb-1">
        <i class="bi bi-tag-fill me-1"></i>Tipo: ${escapeHtml(pinData.tipoNC || 'N/A')}
      </p>
      <p class="small text-muted mb-1">
        <i class="bi bi-hourglass-split me-1"></i>Estatus: ${escapeHtml(pinData.estatus || 'N/A')}
      </p>
      <p class="small text-muted mb-1">
        <i class="bi bi-calendar-fill me-1"></i>Fecha: ${fechaCreacionFormateada}
      </p>
      <p class="small text-muted mb-2">
        <i class="bi bi-person-fill"></i> Encargado: ${escapeHtml(pinData.encargado || 'No asignado')}
      </p>
      ${pinData.imagenURL ? `
        <div class="mb-2">
          <a href="${pinData.imagenURL}" target="_blank" class="d-block">
            <img src="${pinData.imagenURL}" alt="Imagen" class="img-fluid rounded">
          </a>
        </div>
      ` : ''}
      ${isAdmin ? `
        <div class="d-flex gap-2 justify-content-end">
          <button class="btn btn-sm btn-outline-primary"
                  onclick="event.stopPropagation(); window.editarPin('${id}', ${pinData.x}, ${pinData.y}, '${escapeHtml(pinData.titulo)}', '${escapeHtml(pinData.descripcion)}', '${pinData.imagenURL || ''}', '${escapeHtml(pinData.encargado || '')}', '${escapeHtml(pinData.tipoNC || '')}', '${escapeHtml(pinData.estatus || '')}', '${escapeHtml(pinData.fechaCreacion || '')}', '${escapeHtml(pinData.imagenId || '')}')">
            <i class="bi bi-pencil-fill"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger"
                  onclick="event.stopPropagation(); window.eliminarPin('${id}')">
            <i class="bi bi-trash-fill"></i>
          </button>
        </div>
      ` : ''}
    </div>
  `;
  contenedor.appendChild(div);
}

window.editarPin = (id, x, y, titulo, descripcion, imagenURL, encargado, tipoNC, estatus, fechaCreacion, imagenId) => {
  if (!isAdmin) {
    alert("Permiso denegado. Solo los administradores pueden editar pines.");
    return;
  }
  editandoPinId = id;
  const rect = imagen.getBoundingClientRect();
  clickPos = { x: (x / 100) * rect.width, y: (y / 100) * rect.height };

  tituloInput.value = titulo;
  descripcionInput.value = descripcion;
  imagenURLInput.value = imagenURL || '';
  encargadoInput.value = encargado || '';
  tipoNCInput.value = tipoNC || '';
  estatusInput.value = estatus || '';
  fechaCreacionInput.value = fechaCreacion || '';
  formTitulo.textContent = 'Editar Pin';

  pinEnEdicion = contenedor.querySelector(`.pin-con-tooltip[data-pin-id="${id}"]`);

  if (pinEnEdicion) {
    pinEnEdicion.style.zIndex = '1000';
    pinEnEdicion.querySelector('.pin').classList.add('modo-edicion');
  } else {
    console.error("ERROR: No se encontró el pin en el DOM para edición con ID:", id);
  }

  toggleFormFields(true);
  mostrarFormulario(true);
};

btnReposicionar.addEventListener('click', () => {
  if (!isAdmin) return;
  formularioModal.hide();
  reposicionandoPin = true;
  contenedor.classList.add('reposicionando');

  if (pinEnEdicion) {
    pinEnEdicion.style.left = `${clickPos.x}px`; // Esto podría ser un problema si clickPos no está actualizado.
    pinEnEdicion.style.top = `${clickPos.y}px`;  // Debería ser clickPos actual del mapa no del pin original
    pinEnEdicion.querySelector('.pin').classList.remove('modo-edicion');
    pinEnEdicion.style.zIndex = '10';
  }
  alert("Haz clic en el mapa para la nueva posición del pin.");
});


window.eliminarPin = async (id) => {
  if (!isAdmin) {
    alert("Permiso denegado. Solo los administradores pueden eliminar pines.");
    return;
  }
  if (!confirm("¿Está seguro que desea eliminar este pin?")) return;
  try {
    await deleteDoc(doc(db, "pines", id));
  } catch (e) {
    alert("Error al eliminar el pin: " + e.message);
    console.error("Error:", e);
  }
};

function cargarPines(imagenId) {
  if (unsubscribePines) unsubscribePines();
  const q = query(pinesRef, where("imagenId", "==", imagenId));
  unsubscribePines = onSnapshot(q, (snapshot) => {
    contenedor.querySelectorAll('.pin-con-tooltip').forEach(el => el.remove());
    listaPinesUl.innerHTML = "";
    const encargadosSet = new Set();

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      agregarPinVisual(data, docSnap.id);
      if (data.encargado) encargadosSet.add(data.encargado);

       let fechaCreacionLista = 'N/A';
        if (data.fechaCreacion) {
            const parts = data.fechaCreacion.split('-');
            const localDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            fechaCreacionLista = localDate.toLocaleDateString('es-CL');
        }

      const li = document.createElement("li");
      li.className = "list-group-item";
      li.dataset.encargado = data.encargado || "";
      li.dataset.pinId = docSnap.id;
      li.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h6 class="mb-1">${escapeHtml(data.titulo)}</h6>
            <small class="text-muted">${escapeHtml(data.descripcion || 'Sin descripción')}</small>
            <div>
                <span class="badge bg-primary me-1">${escapeHtml(data.tipoNC || 'N/A')}</span>
                <span class="badge bg-info text-dark">${escapeHtml(data.estatus || 'N/A')}</span>
            </div>
            <div>
                <span class="badge bg-success me-1">Fecha: ${fechaCreacionLista}</span>
                <span class="badge bg-secondary">${escapeHtml(data.encargado || 'No asignado')}</span>
            </div>
          </div>
          ${isAdmin ? `
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="window.editarPin('${docSnap.id}', ${data.x}, ${data.y}, '${escapeHtml(data.titulo)}', '${escapeHtml(data.descripcion)}', '${data.imagenURL || ''}', '${escapeHtml(data.encargado || '')}', '${escapeHtml(data.tipoNC || '')}', '${escapeHtml(data.estatus || '')}', '${escapeHtml(data.fechaCreacion || '')}', '${escapeHtml(data.imagenId || '')}')">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-outline-danger" onclick="window.eliminarPin('${docSnap.id}')">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          ` : ''}
        </div>
      `;
      listaPinesUl.appendChild(li);
    });

    const currentFiltro = filtroEncargado.value;
    filtroEncargado.innerHTML = `<option value="todos">Todos</option>`;
    [...encargadosSet].sort().forEach(encargado => {
      const option = document.createElement("option");
      option.value = encargado;
      option.textContent = encargado;
      filtroEncargado.appendChild(option);
    });
    if ([...encargadosSet].includes(currentFiltro) || currentFiltro === 'todos') {
        filtroEncargado.value = currentFiltro;
    }
    aplicarFiltro();
  });
}

function aplicarFiltro() {
  const encargadoSeleccionado = filtroEncargado.value;
  const pines = contenedor.querySelectorAll('.pin-con-tooltip');
  const itemsLista = listaPinesUl.querySelectorAll('li');

  pines.forEach(pin => {
    const encargado = pin.dataset.encargado;
    pin.style.display = (encargadoSeleccionado === 'todos' || encargado === encargadoSeleccionado) ? 'block' : 'none';
  });

  itemsLista.forEach(item => {
    const encargado = item.dataset.encargado;
    item.style.display = (encargadoSeleccionado === 'todos' || encargado === encargadoSeleccionado) ? 'block' : 'none';
  });
}
filtroEncargado.addEventListener('change', aplicarFiltro);

async function generarCsv() {
  if (!isAdmin) {
    alert("Permiso denegado. Solo los administradores pueden descargar CSV.");
    return;
  }
  try {
    const snapshot = await getDocs(pinesRef);
    let csvContent = "";
    const headers = [
      "ID", "Titulo", "Descripcion", "Tipo de NC", "Estatus", "Fecha de Creacion",
      "Encargado", "URL Imagen", "Mapa (ID Imagen)", "Coordenada X (%)", "Coordenada Y (%)"
    ];
    csvContent += headers.map(h => escapeCsv(h)).join(',') + '\n';

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const row = [
        docSnap.id, data.titulo, data.descripcion, data.tipoNC, data.estatus,
        data.fechaCreacion, data.encargado, data.imagenURL, data.imagenId, data.x, data.y
      ];
      csvContent += row.map(item => escapeCsv(item)).join(',') + '\n';
    });

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', 'pines_nc.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    alert("CSV de pines descargado exitosamente.");
  } catch (error) {
    console.error("Error al generar o descargar el CSV:", error);
    alert("Hubo un error al descargar el archivo CSV.");
  }
}
downloadCsvBtn.addEventListener('click', generarCsv);

contenedor.addEventListener('click', function(e) {
  if (!isAdmin) {
    console.warn("Solo los administradores pueden agregar/reposicionar pines.");
    // Si no es admin, y no está haciendo clic en un pin existente, no hacer nada.
    if (!e.target.closest('.pin-con-tooltip')) {
        return;
    }
  }

  // Si el clic fue sobre un pin o su tooltip, no hacer nada más aquí (dejar que los botones del tooltip manejen la acción)
  if (e.target.closest('.pin') || e.target.closest('.tooltip')) {
      return;
  }


  if (reposicionandoPin && isAdmin) { // Solo si es admin y está reposicionando
    const rect = imagen.getBoundingClientRect();
    clickPos.x = e.clientX - rect.left;
    clickPos.y = e.clientY - rect.top;

    // No mover el pin visualmente aquí, se hará al confirmar o guardar
    // if (pinEnEdicion) {
    //   pinEnEdicion.style.left = `${clickPos.x}px`;
    //   pinEnEdicion.style.top = `${clickPos.y}px`;
    //   pinEnEdicion.querySelector('.pin').classList.remove('modo-edicion');
    //   pinEnEdicion.style.zIndex = '10';
    // }

    reposicionandoPin = false;
    contenedor.classList.remove('reposicionando');
    mostrarFormulario(true); // Reabre el formulario en modo edición
    // Actualizar las instrucciones en el formulario
    instruccionesArrastre.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Nueva posición seleccionada. Confirma los detalles y guarda.';
    instruccionesArrastre.classList.remove('d-none');
    toggleFormFields(true); // Habilitar campos del formulario

  } else if (!editandoPinId && isAdmin) { // Solo si es admin y va a crear un nuevo pin
    const rect = imagen.getBoundingClientRect();
    clickPos.x = e.clientX - rect.left;
    clickPos.y = e.clientY - rect.top;

    mostrarFormulario(false); // Abre el formulario para un nuevo pin
    toggleFormFields(true); // Habilitar campos del formulario
    instruccionesArrastre.innerHTML = '<i class="bi bi-check-circle-fill me-2"></i>Posición del pin seleccionada. Completa los detalles y guarda.';
    instruccionesArrastre.classList.remove('d-none');
    
    const today = new Date();
    const year = today.getFullYear();
    const month = (today.getMonth() + 1).toString().padStart(2, '0');
    const day = today.getDate().toString().padStart(2, '0');
    fechaCreacionInput.value = `${year}-${month}-${day}`;
  }
});

uploadCsvBtn.addEventListener('click', handleUploadCsv);

analysisBtn.addEventListener('click', () => {
    window.location.href = 'dashboard.html';
});

// Exportar funciones globales
window.guardarPin = guardarPin;
window.cerrarFormulario = cerrarFormulario;
window.editarPin = editarPin;
window.eliminarPin = eliminarPin;

// Llamadas iniciales
updateNavbarAndAdminFeatures();
cargarImagen(selectorMapa.value);

</script>
</body>
</html>
